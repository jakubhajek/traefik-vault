# Traefik Enterprise with Vault Enterprise PKI

Export the following variables to access Vault Enterprise using Vault CLI:

```sh
export VAULT_ADDR=https://vault-cluster.private.vault.50108fb6-25db-4763-b37f-16866f03465a.aws.hashicorp.cloud:8200/
```

```sh
export VAULT_TOKEN=s.CFTom1rRjWePpKMjZmY3zWHF.ZJfvS
```
```sh
export VAULT_NAMESPACE=admin
```

In order to communicate with Vault Cluster running on Hashicorp Cloud Platform you can run a temporary pod with Vault CLI installed. Then by exporting the mentioned variables you can connect to Vault Cluster and execute the following commands.

1. Enable PKI secrets engine

```sh
 vault secrets enable pki
``` 

2. Set the default TTL (1y)
```sh
vault secrets tune -max-lease-ttl=8760h pki
```

3. Configure a CA certificate and private key.
```sh
vault write pki/root/generate/internal  \
	common_name=aws.traefiklabs.tech ttl=8760h
```

4. Configure the Certificate Revocation List (CRL) location and issuing certificates

```sh
vault write pki/config/urls \
issuing_certificates="https://vault-cluster.private.vault.50108fb6-25db-4763-b37f-16866f03465a.aws.hashicorp.cloud:8200/v1/pki/ca" \
crl_distribution_points="https://vault-cluster.private.vault.50108fb6-25db-4763-b37f-16866f03465a.aws.hashicorp.cloud:8200/v1/pki/crl"
```

5. Configure a role (`vault-role`) that maps a name in Vault with custom TTL. 

```sh
vault write pki/roles/vault-role  \
	allowed_domains=tee.aws.traefiklabs.tech \
	allow_subdomains=true max_ttl=72h
```

6. Generate a new credentails

```sh
vault write pki/issue/vault-role  \
common_name=app.tee.aws.traefiklabs.tech
```  

## Traefik's Enterprise Configuration

Once the initial configuration is completed, the following configuration has to be added to the Traefik's Enterprise static configuration:

```sh
 certificatesResolvers:
     vaultpki:
       vault:
>        url: "https://vault-cluster.private.vault.50108fb6-25db-4763-b37f-16866f03465a.aws.hashicorp.cloud:8200"
         auth:
           token: "s.MMU0zXjSRyBUzKLrrBSgulX2.ZJfvS"
         enginePath: "pki"
         role: "vault-role"
         namespace: "admin"
```
Please note that token generated by HCP UI will expire in 6 hours. We encourage to generate a token that has expiration time set to much longer to avoid service ineruption. 

https://learn.hashicorp.com/tutorials/vault/tokens

```sh
vault token create -ttl=700h -policy=default -policy=hcp-root
```
```sh 
Key                  Value
---                  -----
token                s.ogqsBnUINxpNfbQfUURxrw6m.ZJfvS
token_accessor       xrcgZBW2RXKksGrRZi66u51z.ZJfvS
token_duration       700h
token_renewable      true
token_policies       ["default"]
identity_policies    []
policies             ["default"]
```


The following lines entries should be found in the controller log files. That means that Traefik Enterprise has correctly started the Vault PKI certificate resolver and also loaded already exisiting TLS certificates.


```sh
tee-controller-0 tee-controller time="2022-02-28T16:24:52Z" level=info msg="Starting provider *vault.PKIProvider"
tee-controller-0 tee-controller time="2022-02-28T16:24:52Z" level=info msg="Starting Vault PKI certificate resolver" service=provider providerName=vaultpki.vault role=controller no_store=false node=tee-controller-0 ttl=72h0m0s
tee-controller-0 tee-controller time="2022-02-28T16:24:53Z" level=info msg="Resolving certificate" node=tee-controller-0 service=provider providerName=vaultpki.vault domains=app.tee.aws.traefiklabs.tech role=controller
tee-controller-0 tee-controller time="2022-02-28T16:24:53Z" level=info msg="Resolved certificate" domains="[app.tee.aws.traefiklabs.tech]" role=controller node=tee-controller-0 service=provider providerName=vaultpki.vault
```
## Validate the configuration 

Create the following sample Ingressroute objects: 

```sh
kubectl apply -f ingressroute-1.yaml
```
```sh
kubectl apply -f ingressroute-2.yaml
```

Once the new routers are being created, the certificate will be automatically created and stored in Vault PKI


```sh
tee-proxy-8bddfd544-8nbkh tee-proxy time="2022-02-28T16:41:49Z" level=info msg="Applying a new dynamic configuration" role=ingress module=server node=tee-proxy-8bddfd544-8nbkh
tee-controller-0 tee-controller time="2022-02-28T16:41:49Z" level=info msg="Resolved certificate" providerName=vaultpki.vault domains="[app-whoami-1.tee.aws.traefiklabs.tech]" role=controller node=tee-controller-0 service=provider
```

Validate the certificate by executing the following command:

```sh
curl https://app-whoami-2.tee.aws.traefiklabs.tech
```

The following TLS certificate should be presented.

```sh
* Server certificate:
*  subject: CN=app-whoami-2.tee.aws.traefiklabs.tech
*  start date: Feb 28 16:41:19 2022 GMT
*  expire date: Feb 28 17:41:49 2022 GMT
*  issuer: CN=aws.traefiklabs.tech
*  SSL certificate verify result: unable to get local issuer certificate (20), continuing anyway.
```


# Traefik Vault Provider

The Vault provider allows to Traefik Enterprise to use TLS certificates using the KV secret engine
https://doc.traefik.io/traefik-enterprise/providers/vault-kv/

## Enable KV engine

Ensure to update the namespace variable to `admin/ns1` and enable the KV engine:

```
vault secrets enable -version=2 -path=kv kv
```

## Configure Traefik Vault Provider - Vault KV

```sh
plugin:
    vault:
      url: "https://vault-cluster.private.vault.50108fb6-25db-4763-b37f-16866f03465a.aws.hashicorp.cloud:8200"
      auth:
        token: "s.m3kWCLW7qeKpyHPngr6pg33p.ZJfvS"
      enginePath: "kv"
      syncInterval: "5s"
      rescanInterval: "60s"
      namespace: "admin/ns1"
```


```sh
tee-controller-0 tee-controller time="2022-03-01T10:44:46Z" level=info msg="Starting Vault KV provider" service=provider node=tee-controller-0 providerName=vaultKV sync_interval=5s rescan_interval=1m0s role=controller
```
## Genertate self signed certificate:

```sh
openssl req -x509 -newkey rsa:4096 \
-keyout key.pem -out cert.pem \
-sha256 -nodes -days 365 \
-subj "/C=PL/ST=Mazowieckie/L=Warsaw/O=TraefikLabs/OU=Org/CN=app.
kv.aws.traefiklabs.tech" \
-addext "subjectAltName=DNS.1:app2.kv.aws.traefiklabs.tech,DNS.2:a
pp3.kv.aws.traefiklabs.tech"
```

Add a new secret with the following command: 

```sh
vault kv put kv/app.kv.aws.traefiklabs.tech  cert="$(cat cert.pem | base64 -w0)" key="$(cat key.pem | base64 -w0)"
```

## Create Ingressroute objects

```sh
kubectl apply -f ingressroute-3-kv.yaml
```

```sh
kubectl apply -f ingressroute-4-kv.yaml
```

Once the routers are created the following commands can be run in order to test connectivity and the TLS certificates. 

```sh
curl https://app1.kv.aws.traefiklabs.tech -k -Iv
```

```
* Server certificate:
*  subject: C=PL; ST=Mazowieckie; L=Warsaw; O=TraefikLabs; OU=Org; CN=app.kv.aws.traefiklabs.tech
*  start date: Mar  1 13:28:31 2022 GMT
*  expire date: Mar  1 13:28:31 2023 GMT
*  issuer: C=PL; ST=Mazowieckie; L=Warsaw; O=TraefikLabs; OU=Org; CN=app.kv.aws.traefiklabs.tech
```

```sh
curl https://app2.kv.aws.traefiklabs.tech -k -Iv
```